(()=>{"use strict";const e="source-over";class t extends EventTarget{constructor(t,s,n=!1){super(),this.strokes=new Array,this.canvas_element=t,this.context=this.canvas_element.getContext("2d"),this.controls_element=s,this.paint=!1,this.color="#000000",this.size=5,this.traceback=0,this.mode=e,this.canvas_element.ontouchstart=this.canvas_element.onmousedown=e=>this.onTouch(e),this.canvas_element.ontouchmove=this.canvas_element.onmousemove=e=>this.onUntouch(e),this.canvas_element.ontouchend=this.canvas_element.onmouseleave=this.canvas_element.onmouseup=e=>{this.redraw(),this.paint=!1,this.dispatchEvent(new CustomEvent("stroke"))},n&&(this.controls={color:document.createElement("input"),stroke:document.createElement("input"),erase:document.createElement("button"),pencil:document.createElement("button"),undo:document.createElement("button")},this.controls.color.type="color",this.controls.color.classList.add("colorpicker"),this.controls.stroke.type="range",this.controls.stroke.value="5",this.controls.stroke.min="1",this.controls.stroke.max="50",this.controls.stroke.classList.add("sizepicker"),this.controls.erase.classList.add("erasebutton"),this.controls.erase.innerHTML="Erase",this.controls.pencil.classList.add("pencilbutton"),this.controls.pencil.innerHTML="Draw",this.controls.undo.classList.add("undobutton"),this.controls.undo.innerHTML="Undo",s.appendChild(document.createTextNode("Color: ")),s.appendChild(this.controls.color),s.appendChild(document.createTextNode("Stroke: ")),s.appendChild(this.controls.stroke),s.appendChild(this.controls.erase),s.appendChild(this.controls.pencil),s.appendChild(this.controls.undo),this.controls.color.onchange=t=>{this.mode=e,this.color=t.target.value},this.controls.stroke.onchange=e=>{this.size=e.target.value},this.controls.undo.onclick=e=>this.undo(e),this.controls.pencil.onclick=e=>this.pencil(e),this.controls.erase.onclick=e=>this.erase(e))}getStrokes(){return this.strokes}clearCanvas(){this.strokes.length=0,this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.dispatchEvent(new CustomEvent("change"))}getCanvas(){return this.canvas_element}redraw(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.lineJoin="round";for(var e=0;e<this.strokes.length;e++)this.context.strokeStyle=this.strokes[e].c,this.context.lineWidth=this.strokes[e].s,this.context.globalCompositeOperation=this.strokes[e].m,this.context.beginPath(),this.strokes[e].d&&e?this.context.moveTo(this.strokes[e-1].x*this.context.canvas.width/1e3,this.strokes[e-1].y*this.context.canvas.height/1e3):this.context.moveTo(this.strokes[e].x*this.context.canvas.width/1e3-1,this.strokes[e].y*this.context.canvas.height/1e3),this.context.lineTo(this.strokes[e].x*this.context.canvas.width/1e3,this.strokes[e].y*this.context.canvas.height/1e3),this.context.closePath(),this.context.stroke();this.dispatchEvent(new CustomEvent("redraw"))}setSize(){let e=this.controls_element?1.5*this.controls_element.offsetHeight:0,t=window.innerHeight-e-this.canvas_element.getBoundingClientRect().top;this.canvas_element.style.width=t,this.canvas_element.style.height=t,this.canvas_element.setAttribute("width",t),this.canvas_element.setAttribute("height",t),this.redraw()}onTouch(e){e.preventDefault(),this.traceback=0,this.paint=!0;var t=getComputedStyle(e.target).getPropertyValue("border-left-width");t=parseInt(t);var s=e.changedTouches;s?this.addClick((s[0].pageX-e.target.offsetLeft-t)/this.context.canvas.width*1e3,(s[0].pageY-e.target.offsetTop-t)/this.context.canvas.height*1e3,this.color,this.size,this.mode):this.addClick((e.pageX-e.target.offsetLeft-t)/this.context.canvas.width*1e3,(e.pageY-e.target.offsetTop-t)/this.context.canvas.height*1e3,this.color,this.size,this.mode),this.redraw()}onUntouch(e){if(e.preventDefault(),this.paint){var t=getComputedStyle(e.target).getPropertyValue("border-left-width");t=parseInt(t);var s=e.changedTouches;s?this.addClick((s[0].pageX-e.target.offsetLeft-t)/this.context.canvas.width*1e3,(s[0].pageY-e.target.offsetTop-t)/this.context.canvas.height*1e3,this.color,this.size,this.mode,!0):this.addClick((e.pageX-e.target.offsetLeft-t)/this.context.canvas.width*1e3,(e.pageY-e.target.offsetTop-t)/this.context.canvas.height*1e3,this.color,this.size,this.mode,!0),this.redraw()}}pencil(){this.mode=e,this.dispatchEvent(new CustomEvent("pencil"))}erase(){this.color="rgba(0,0,0,1)",this.mode="destination-out;",this.dispatchEvent(new CustomEvent("erase"))}undo(){this.strokes.length>0&&(this.strokes.length,this.strokes=this.strokes.slice(0,this.strokes[this.strokes.length-1].t),this.redraw(),this.dispatchEvent(new CustomEvent("undo",{detail:{newlength:this.strokes.length}})))}addClick(e,t,s,n,o,a){this.strokes.push({x:e,y:t,c:s,s:n,m:o,d:a,t:--this.traceback}),this.dispatchEvent(new CustomEvent("change"))}load(e){this.strokes=e.map((e=>JSON.parse(e))),this.dispatchEvent(new CustomEvent("change"))}add(e){this.strokes=this.strokes.concat(e.map((e=>JSON.parse(e)))),this.dispatchEvent(new CustomEvent("change"))}hide(){"none"!=this.canvas_element.style.display&&(this.old_display=this.canvas_element.style.display),this.canvas_element.style.display="none",this.dispatchEvent(new CustomEvent("hidden"))}show(){this.canvas_element.style.display=this.old_display||"block",this.dispatchEvent(new CustomEvent("shown"))}}document.body.onload=function(){var e=null,s=null,n=null,o=null,a=0,i=!0,l=!1,r=null,c=null,d=null;function u(){gMapLobby=new Map,r=new Map,c=new Map,n=null,o=null,a=0,i=!1,l=!1,document.getElementById("user-list-3").innerHTML="",document.getElementById("user-list-2").innerHTML="",document.getElementById("user-list-1").innerHTML="",gMap.set(e,d),d.clearCanvas()}function h(){u(),s=new WebSocket("ws://"+window.location.hostname+":"+window.location.port+"/chat?name="+encodeURIComponent(e)),console.log(s),s.addEventListener("open",(t=>{i=!0,s.send(JSON.stringify({Pull:{username:e,i:0}}))})),s.addEventListener("message",(a=>{const r=a.data;console.log(r);let c=JSON.parse(r);if(c.Reset)u();else if(c.NewName)alert("Name "+e+" is taken! Try again!"),location.reload();else if(c.Guessed){let t=document.getElementById("answers"),s=document.createElement("div"),n=document.createElement("b");for(n.classList="warn",n.textContent=c.Guessed.guesser+" guessed "+c.Guessed.drawer+"'s word for "+c.Guessed.points+" points!",s.append(n,document.createElement("br")),t.append(s),c.Guessed.guesser==e&&f(c.Guessed.drawer),c.Guessed.drawer==e&&v(c.Guessed.guesser);t.children.length>30;)t.removeChild(t.children[0]);t.scrollTop=t.scrollHeight}else if(c.Guess){let e=document.getElementById("answers"),t=document.createElement("div");if(""===c.Guess.username){let e=document.createElement("b");e.classList="warn",e.textContent=c.Guess.guess,t.append(e,document.createElement("br"))}else{let e=document.createElement("b");e.textContent=c.Guess.username+": ",t.append(e,c.Guess.guess,document.createElement("br"))}for(e.append(t);e.children.length>30;)e.removeChild(e.children[0]);e.scrollTop=e.scrollHeight}else if(c.Image){let t=y(c.Image.username,c.Image.image);c.Image.username!=e&&c.Image.i<t.getStrokes().length&&s.send(JSON.stringify({Pull:{username:c.Image.username,i:t.getStrokes().length}})),c.Image.username==e&&i&&(d.load(c.Image.image),i=!1,d.redraw())}else if(c.Undo)!function(s){if(s!=e){if(!gMap.has(s)){let e=document.createElement("canvas");gMap.set(s,new t(e,document.getElementById("controls"),!1)),e.classList="image",document.getElementById("gallery").appendChild(e)}gMap.get(s).undo(),y(s,[])}}(c.Undo.username);else if(c.Assign)n=c.Assign.assignment,document.getElementById("word").textContent="Your word is "+n;else if(c.FullState){l&&"LOBBY"==c.FullState.state.state&&(console.log("NUKED!"),u());let t="RUNNING"==c.FullState.state.state?document.getElementById("user-list-1"):document.getElementById("user-list-2");for(var h in c.FullState.state.players){let s=c.FullState.state.players[h],n=m(h);for(var g in n.setAttribute("active",s.active),l||t.append(n),h==e&&n.setAttribute("me",!0),s.guess_list)h==e?v(g):g==e&&f(h);y(h,[])}for([player,can]of(function(t){o=t;let s=document.getElementById("timer");"RUNNING"==t.state?(document.getElementById("progress-container").style.display="flex",document.getElementById("lobby-container").style.display="none",document.getElementById("endgame-container").style.display="none",s.style.display="block",s.value=t.time,s.max=t.timelimit,d.setSize()):"LOBBY"==t.state?(l=!1,document.getElementById("progress-container").style.display="none",document.getElementById("lobby-container").style.display="block",document.getElementById("endgame-container").style.display="none",s.style.display="none"):"POSTGAME"==t.state&&(document.getElementById("progress-container").style.display="none",document.getElementById("lobby-container").style.display="none",document.getElementById("endgame-container").style.display="block",s.style.display="none",function(){if(l)return;l=!0;let e=document.getElementById("user-list-3"),t=Object.entries(o.players),s=Math.max(...t.map((e=>e[1].score)));for(let n=0;n<t.length;++n)setTimeout((function(){let a=t[n][0],i=m(a);i.style.width="10%",e.appendChild(i);try{let e=document.createElement("div");e.classList="finalimagecontainer";let t=document.createElement("img"),s=gMap.get(a);s&&(s.redraw(),t.src=s.getCanvas().toDataURL()),e.onclick=function(){t.src=gMap.get(a).getCanvas().toDataURL(),Array.prototype.forEach.call(document.getElementsByClassName("finalimagecontainer"),(e=>e.style.display="none"))},e.appendChild(t),document.getElementById("finalgallery").appendChild(e),gImgMap.set(a,e)}catch(e){console.log(e)}i.textContent=a+" [0]",o.players[a].score==s&&i.setAttribute("winner","true"),i.setAttribute("moving","true"),setTimeout((function(){i.style.width=10+80*o.players[a].score/s+"%";var e=0,t=setInterval((function(){(e+=Math.ceil(o.players[a].score/80))>=o.players[a].score&&(e=o.players[a].score,clearInterval(t)),i.textContent=a+" ["+e+"]"}),16);setTimeout((function(){i.setAttribute("moving","false")}),500)}),1e3)}),3e3*n)}()),e==t.host&&(document.getElementById("start").style.display="block",document.getElementById("restart").style.display="block")}(c.FullState.state),"RUNNING"!=c.FullState.state.state||n||s.send(JSON.stringify({Assign:{}})),gMap))s.send(JSON.stringify({Pull:{username:player,i:can.getStrokes().length}}))}})),s.addEventListener("error",(e=>{console.error("WebSocket error:",e)})),s.addEventListener("close",(e=>{setTimeout(h,4e3)}))}function m(e){if(!gMapLobby.has(e)){const t=document.createElement("li");t.textContent=e,t.classList.add("user-list-item"),t.setAttribute("__player",e),t.onclick=g,gMapLobby.set(e,t)}return gMapLobby.get(e)}function g(e){if("RUNNING"==o.state){for(let e of gMap.values())console.log(e),e.hide();for(let e of gMapLobby.values())e.setAttribute("selected","false");let t=gMap.get(e.target.getAttribute("__player"));t.show(),t.setSize(),t.redraw(),d.redraw(),gMapLobby.get(e.target.getAttribute("__player")).setAttribute("selected","true")}else"POSTGAME"==o.state&&(gImgMap.get(e.target.getAttribute("__player")).style.display="block",gImgMap.get(e.target.getAttribute("__player")).querySelector("img").style.display="block")}function p(e){for(e of document.getElementsByClassName("image"))if("none"!=e.style.display)return e}function y(s,n){if(s==e)return;if(!gMap.has(s)){let e=document.createElement("canvas");gMap.set(s,new t(e,document.getElementById("controls"),!1)),e.classList="image",document.getElementById("gallery").appendChild(e)}let o=gMap.get(s);return o.add(n),o.setSize(),o.redraw(),d.redraw(),o}function v(e){let t=m(e);r.has(e)||(r.set(e,t),t.setAttribute("movingguesser","true"),t.setAttribute("guesser","true"),setTimeout((function(){t.setAttribute("movingguesser","false")}),1))}function f(e){let t=m(e);c.has(e)||(c.set(e,t),t.setAttribute("movingguessed","true"),t.setAttribute("guessed","true"),setTimeout((function(){t.setAttribute("movingguessed","false")}),1))}(d=new t(document.getElementById("canvas"),document.getElementById("controls"),!0)).addEventListener("stroke",(function(e){e.preventDefault(),function(){let e=d.getStrokes();var t=e.slice(a).map((e=>JSON.stringify(e)));a=e.length,t.length>0&&s.send(JSON.stringify({Image:{image:t}}))}()})),d.addEventListener("undo",(e=>{a=d.getStrokes().length,s.send(JSON.stringify({Undo:{i:e.detail.newlength}}))})),document.getElementById("name").onkeydown=function(t){"Enter"==t.key&&(e=t.target.value,document.getElementById("game").style.display="block",document.getElementById("login").style.display="none",h(),document.cookie=e)},document.getElementById("guess").addEventListener("keydown",(function(t){var n;"Enter"==t.key?(e=t.target.value,n=t.target.value,s.send(JSON.stringify({Guess:{guess:n}})),t.target.value=""):"Tab"==t.key&&(function(e){if("RUNNING"==o.state){let e=document.querySelector('.user-list-item[selected="true"] + li')||document.querySelector("li.user-list-item:nth-child(1)");console.log(e);for(let e of gMap.values())e.hide();for(let e of gMapLobby.values())e.setAttribute("selected","false");let t=gMap.get(e.getAttribute("__player"));t.show(),t.setSize(),t.redraw(),d.redraw(),gMapLobby.get(e.getAttribute("__player")).setAttribute("selected","true")}}(t.shiftKey),t.preventDefault())})),document.onmouseup=function(){document.getElementById("guess").focus()},document.getElementById("start").onclick=function(e){s.send(JSON.stringify({Start:{}}))},document.getElementById("restart").onclick=function(e){s.send(JSON.stringify({Restart:{}}))},document.getElementById("progress-container").style.display="none",document.getElementById("lobby-container").style.display="none",document.getElementById("endgame-container").style.display="none",""!=document.cookie&&(document.getElementById("name").value=document.cookie),window.onresize=function(){try{see_element(p()),redraw_other(p().getContext("2d"),gstrks),redraw()}catch{}},setInterval((function(){o&&"RUNNING"==o.state&&(document.getElementById("timer").value+=1)}),1e3)}})();